name: build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'é€‰æ‹©è¦æ‰“åŒ…çš„åˆ†æ”¯'
        required: true
        default: 'main'
        type: string
      trade_no:
        description: 'è®¢å•å·ï¼ˆè‡ªåŠ¨æž„å»ºæ—¶ä¼ å…¥ï¼‰'
        required: false
        type: string
      email:
        description: 'ç”¨æˆ·é‚®ç®±ï¼ˆç”¨äºŽäº§ç‰©å‘½åï¼‰'
        required: false
        type: string
      callback_url:
        description: 'æž„å»ºå›žè°ƒåœ°å€'
        required: false
        type: string

env:
  IS_STABLE: ${{ !contains(github.ref, '-') }}
  SOURCE_BRANCH: ${{ github.event.inputs.source_branch || 'main' }}
  TRADE_NO: ${{ github.event.inputs.trade_no || '' }}
  USER_EMAIL: ${{ github.event.inputs.email || '' }}
  CALLBACK_URL: ${{ github.event.inputs.callback_url || '' }}
  CALLBACK_SECRET: ${{ secrets.BUILD_CALLBACK_SECRET }}

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: android
            os: ubuntu-latest
            platform_id: android
          - platform: windows
            os: windows-2022
            arch: amd64
            platform_id: windows-amd64
          - platform: linux
            os: ubuntu-22.04
            arch: amd64
            platform_id: linux-amd64
          - platform: macos
            os: macos-15-intel
            arch: amd64
            platform_id: macos-amd64
          - platform: macos
            os: macos-latest
            arch: arm64
            platform_id: macos-arm64
          - platform: windows
            os: windows-11-arm
            arch: arm64
            platform_id: windows-arm64
          - platform: linux
            os: ubuntu-24.04-arm
            arch: arm64
            platform_id: linux-arm64

    steps:
      # å›žè°ƒï¼šå¼€å§‹æž„å»º
      - name: Notify build started
        if: ${{ env.TRADE_NO != '' }}
        shell: bash
        run: |
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "trade_no": "${{ env.TRADE_NO }}",
              "platform": "${{ matrix.platform_id }}",
              "step": "clone",
              "message": "å¼€å§‹å…‹éš†ä»£ç ...",
              "secret": "${{ env.CALLBACK_SECRET }}"
            }' || true

      - name: Free disk space (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h

      - name: Setup rust
        if: startsWith(matrix.os, 'windows-11-arm')
        run: |
          Invoke-WebRequest -Uri "https://win.rustup.rs/aarch64" -OutFile rustup-init.exe
          .\rustup-init.exe -y --default-toolchain stable
          $cargoPath = "$env:USERPROFILE\.cargo\bin"
          Add-Content $env:GITHUB_PATH $cargoPath

      - name: Clone private repository
        env:
          PRIVATE_REPO_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        shell: bash
        run: |
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          echo "ðŸ“¦ å…‹éš†åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}"
          git clone -b "${{ env.SOURCE_BRANCH }}" "https://x-access-token:${PRIVATE_REPO_TOKEN}@github.com/clash9527/Orange.git" private-source
          cd private-source
          git submodule init
          echo "ðŸ”§ å…‹éš†å¼€æºå­æ¨¡å—..."
          git clone --depth 1 -b FlClash https://github.com/chen08209/Clash.Meta.git core/Clash.Meta
          git clone --depth 1 https://github.com/hakimi-x/flutter_xboard_sdk.git lib/sdk/flutter_xboard_sdk
          git clone --depth 1 -b FlClash https://github.com/chen08209/flutter_distributor.git plugins/flutter_distributor
          echo "âœ… æ‰€æœ‰å­æ¨¡å—å…‹éš†å®Œæˆ"
          cd ..

      - name: Checkout public repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          path: public-repo

      - name: Prepare build environment
        shell: bash
        run: |
          cp -r private-source/* ./
          rm -rf .github
          cp -r public-repo/.github ./
          if [ -f "lib/sdk/flutter_xboard_sdk/pubspec.yaml" ]; then
            echo "âœ… flutter_xboard_sdk å·²å‡†å¤‡å°±ç»ª"
          else
            echo "âŒ flutter_xboard_sdk ç¼ºå¤±"
            exit 1
          fi
          if [ -f "core/Clash.Meta/go.mod" ]; then
            echo "âœ… Clash.Meta æ ¸å¿ƒå·²å‡†å¤‡å°±ç»ª"
          else
            echo "âŒ Clash.Meta æ ¸å¿ƒç¼ºå¤±"
            exit 1
          fi
          rm -rf private-source public-repo

      # å›žè°ƒï¼šä¾èµ–å®‰è£…
      - name: Notify deps started
        if: ${{ env.TRADE_NO != '' }}
        shell: bash
        run: |
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "trade_no": "${{ env.TRADE_NO }}",
              "platform": "${{ matrix.platform_id }}",
              "step": "deps",
              "message": "å®‰è£…ä¾èµ–ä¸­...",
              "secret": "${{ env.CALLBACK_SECRET }}"
            }' || true

      - name: Setup Android Signing
        if: startsWith(matrix.platform,'android')
        run: |
          echo "${{ secrets.KEYSTORE }}" | base64 --decode > android/app/keystore.jks
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/local.properties
          echo "storePassword=${{ secrets.STORE_PASSWORD }}" >> android/local.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/local.properties

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'
          cache-dependency-path: core/go.sum

      - name: Setup Flutter (ARM)
        if: matrix.arch == 'arm64'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: 'master'
          cache: true

      - name: Setup Flutter (AMD64)
        if: matrix.arch != 'arm64'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.6'
          channel: 'stable'
          cache: true

      - name: Get Flutter Dependency
        run: flutter pub get

      - name: Generate code for flutter_xboard_sdk
        shell: bash
        run: |
          if [ -d "lib/sdk/flutter_xboard_sdk" ]; then
            cd lib/sdk/flutter_xboard_sdk
            flutter pub get
            flutter packages pub run build_runner build --delete-conflicting-outputs
            cd ../../..
          fi

      - name: Generate code for main project
        run: flutter packages pub run build_runner build --delete-conflicting-outputs

      - name: Update Go modules
        shell: bash
        run: |
          if [ -f "core/go.mod" ]; then
            cd core
            go mod tidy
            cd ..
          fi

      - name: Fix Package.resolved for macOS
        if: matrix.platform == 'macos'
        shell: bash
        run: find . -name "Package.resolved" -type f -delete

      # å›žè°ƒï¼šå¼€å§‹ç¼–è¯‘
      - name: Notify build started
        if: ${{ env.TRADE_NO != '' }}
        shell: bash
        run: |
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "trade_no": "${{ env.TRADE_NO }}",
              "platform": "${{ matrix.platform_id }}",
              "step": "build",
              "message": "æ­£åœ¨ç¼–è¯‘...",
              "secret": "${{ env.CALLBACK_SECRET }}"
            }' || true

      - name: Setup
        run: dart setup.dart ${{ matrix.platform }} ${{ matrix.arch && format('--arch {0}', matrix.arch) }} ${{ env.IS_STABLE == 'true' && '--env stable' || '' }}

      # å›žè°ƒï¼šä¸Šä¼ äº§ç‰©
      - name: Notify upload started
        if: ${{ env.TRADE_NO != '' }}
        shell: bash
        run: |
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "trade_no": "${{ env.TRADE_NO }}",
              "platform": "${{ matrix.platform_id }}",
              "step": "upload",
              "message": "ä¸Šä¼ äº§ç‰©ä¸­...",
              "secret": "${{ env.CALLBACK_SECRET }}"
            }' || true

      - name: Rename artifacts for custom build
        if: ${{ env.TRADE_NO != '' }}
        shell: bash
        run: |
          cd ./dist
          DATE=$(date +%Y%m%d)
          USER_ID="${{ env.USER_EMAIL }}"
          USER_ID="${USER_ID%%@*}"
          if [ -z "$USER_ID" ]; then
            USER_ID="${{ env.TRADE_NO }}"
          fi
          for file in *; do
            if [ -f "$file" ]; then
              ext="${file##*.}"
              newname="${USER_ID}_${DATE}_${{ matrix.platform_id }}.${ext}"
              mv "$file" "$newname"
              echo "âœ… $file -> $newname"
            fi
          done

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TRADE_NO != '' && format('{0}-{1}', env.TRADE_NO, matrix.platform_id) || format('artifact-{0}-{1}', env.SOURCE_BRANCH, matrix.platform_id) }}
          path: ./dist
          overwrite: true

      # å›žè°ƒï¼šæž„å»ºå®Œæˆ
      - name: Notify build completed
        if: ${{ env.TRADE_NO != '' && success() }}
        shell: bash
        run: |
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "trade_no": "${{ env.TRADE_NO }}",
              "platform": "${{ matrix.platform_id }}",
              "step": "completed",
              "message": "æž„å»ºå®Œæˆ",
              "secret": "${{ env.CALLBACK_SECRET }}"
            }' || true

      # å›žè°ƒï¼šæž„å»ºå¤±è´¥
      - name: Notify build failed
        if: ${{ env.TRADE_NO != '' && failure() }}
        shell: bash
        run: |
          curl -X POST "${{ env.CALLBACK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "trade_no": "${{ env.TRADE_NO }}",
              "platform": "${{ matrix.platform_id }}",
              "step": "failed",
              "message": "æž„å»ºå¤±è´¥",
              "secret": "${{ env.CALLBACK_SECRET }}"
            }' || true

  changelog:
    permissions: write-all
    runs-on: ubuntu-latest
    needs: [build]
    if: ${{ !contains(github.ref, '-') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: refs/heads/main
      - name: Download CHANGELOG
        env:
          PRIVATE_REPO_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          curl -H "Authorization: token ${PRIVATE_REPO_TOKEN}" \
               -H "Accept: application/vnd.github.v3.raw" \
               -o CHANGELOG.md \
               https://api.github.com/repos/clash9527/Orange/contents/CHANGELOG.md
      - name: Commit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add CHANGELOG.md
          if ! git diff --cached --quiet; then
            git config --local user.email "bot@example.com"
            git config --local user.name "CI Bot"
            git commit -m "Update changelog"
            git push || true
          fi

  upload:
    permissions: write-all
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ !contains(github.ref, '-') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download
        uses: actions/download-artifact@v4
        with:
          path: ./dist/
          pattern: artifact-${{ env.SOURCE_BRANCH }}-*
          merge-multiple: true
      - name: Download release.md
        env:
          PRIVATE_REPO_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          curl -H "Authorization: token ${PRIVATE_REPO_TOKEN}" \
               -H "Accept: application/vnd.github.v3.raw" \
               -o release.md \
               https://api.github.com/repos/clash9527/Orange/contents/.github/release.md || echo "# Release" > release.md
      - name: Generate sha256
        run: |
          cd ./dist
          for file in $(find . -type f -not -name "*.sha256"); do
            sha256sum "$file" > "${file}.sha256"
          done
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./dist/*
          body_path: './release.md'
          generate_release_notes: false
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
